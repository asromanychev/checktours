#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

echo "== Installing dependencies =="
gem install bundler --conservative >/dev/null 2>&1 || true
bundle check >/dev/null 2>&1 || bundle install

if [ ! -f .env ]; then
  cat > .env <<'EOF'
# Fill in your bot token from BotFather
TELEGRAM_BOT_TOKEN=put-your-token-here

# Redis URL for Sidekiq (optional if you don't run worker)
REDIS_URL=redis://127.0.0.1:6379/0
SIDEKIQ_CONCURRENCY=5
EOF
  echo "Created .env. Edit TELEGRAM_BOT_TOKEN before chatting with the bot."
fi

if ! grep -q "^TELEGRAM_BOT_TOKEN=" .env; then
  echo "WARNING: TELEGRAM_BOT_TOKEN is not set in .env"
fi

echo "== Preparing database =="
bin/rails db:prepare

echo "== Starting app (web, worker, telegram) =="
exec bundle exec foreman start 